{% extends "layout.html" %}
{% block body %}
<script type=text/javascript src="{{ url_for('static', filename='jquery.flot.js') }}"></script>
<script type=text/javascript src="{{ url_for('static', filename='jquery.flot.selection.js') }}"></script>
<script type=text/javascript>

  var Sources = 
  {
   {% for source in sources %}
   {{source}} : { updater : null }, 
   {% endfor %}
  };
    
$(document).ready(function(){
  var plotrows = '';
  plotrows += '<table>';
  for(sourcename in Sources) {
    plotrows += '<tr>';
    plotrows += ' <td>';
    if(sourcename == "temperature" || sourcename == "humidity" || sourcename == "light")
      plotrows += "<img src=\"/static/"+sourcename+"_icon.svg\"/ style=\"height:30px;\"\>";
    plotrows += ' <h4>' + sourcename+'</h4>';
    plotrows += ' </td>';
    plotrows += ' <td>';
    plotrows += '  <div id="plot_'+sourcename+'" style="width:500px;height:150px;"></div>';
    plotrows += ' </td>';
    plotrows += ' <td>';
    plotrows += ' <p><div class="well" style="height:20px; width:30px; padding:50px; font-size:30px;" id="currval_'+sourcename+'"></div></p>';
    plotrows += ' </td>';
    plotrows += ' <td>';
    plotrows += buildTimeSelector(sourcename);
    plotrows += ' </td>';
    plotrows += '</tr>';
  }
  plotrows += '</tables>';
  $("#plots").html(plotrows);

  for(sourcename in Sources)
    selectTime(null, sourcename);

  updateCurrents();
  setInterval("updateCurrents()", 1000);
});

function updateCurrents()
{

  $.getJSON($SCRIPT_ROOT + '/_getstatus', {"hwids":"{{hwid}}"}, function(result) {
      var online = result.data["{{hwid}}"]['online'];
      var stat = result.data["{{hwid}}"]['values'];

      for(sourcename in stat)
      {
        var value = "-";
        if(online) value = stat[sourcename]['avg'];
        $("#currval_"+sourcename).html('<span >'+value+'</span>');
      }
    });
}


function callUpdateGraph(hwid, sourcename, start, end, resolution)
{
     updateGraph({{hwid}}, sourcename, start, "N", resolution);
}

function selectTime(ctx, sourcename)
{
  var val = $('#timeselect_'+sourcename).val();

  if(Sources[sourcename].updater != null)
    clearInterval(Sources[sourcename].updater);

  start = "";
  resolution = "";
  switch(val)
  {
    case "minute":
      start = "-60";
      resolution = "1";
      break;
    case "day":
      start = "-86400";
      resolution = "1800";
      break;
    case "week":
      start = "-604800";
      resolution = "3600";
      break;
  }

  updateGraph({{hwid}}, sourcename, start, "N", resolution);

  Sources[sourcename].updater = setInterval(
      "updateGraph('{{hwid}}', '"+sourcename+"', '"+start+"', 'N', '"+resolution+"')",
      resolution*1000);
}

function buildTimeSelector(sourcename)
{
  var _ = '';
  _+= '<select class="small" id="timeselect_'+sourcename+'" onchange="selectTime(this.id, \''+sourcename+'\')">';
  _+= '<option value="minute">1 minute</option>';
  _+= '<option value="day">1 day</option>';
  _+= '<option value="week">1 week</option>';
  _+= '</select>';

  return _;
}

function updateGraph(_hwid, _sourcename, _start, _end, _resolution)
{
  data = []
  $.getJSON($SCRIPT_ROOT + '/_getdata', 
      {
        hwid       : _hwid,
        source     : _sourcename,
        start      : _start,
        end        : _end,
        resolution : _resolution
      },
      function(data) {

        var datastream = data.data;
        Sources[_sourcename].data = datastream;

        // Update the plot
        $.plot($("#plot_"+_sourcename), [
        {
          data: datastream,
          lines: {show: true, fill: true},
          shadowSize: 0                         
        }], {xaxis: {mode: "time"}});

     });
}


</script>

<div class="page-header">
  <h1>Device : {{ hwid }}</h1>
  <a href="{{ url_for('myceres') }}">&lt;&lt; back</a>
</div>  
<div id="plots"></div>

{% endblock %}

